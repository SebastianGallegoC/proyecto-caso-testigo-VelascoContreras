name: CI/CD Pipeline - Calculadora Django + Vue.js

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job 1: Tests Backend Django
  backend-tests:
    name: Backend Tests (Django)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run migrations
      run: |
        python manage.py migrate
    
    - name: Run Django tests
      run: |
        python manage.py test calculadora
    
    - name: Generate coverage report
      run: |
        pip install coverage
        coverage run --source='calculadora' manage.py test calculadora
        coverage report
        coverage xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: backend
        name: backend-coverage

  # Job 2: Tests Frontend Vue.js
  frontend-tests:
    name: Frontend Tests (Vue.js)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./frontend
      run: |
        npm ci
    
    - name: Run Vue tests
      working-directory: ./frontend
      run: |
        npm test -- --run

  # Job 3: Lint & Code Quality
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort
    
    - name: Run flake8
      run: |
        flake8 calculadora calculadora_project --max-line-length=120 --exclude=migrations,venv
      continue-on-error: true
    
    - name: Check code formatting with black
      run: |
        black --check calculadora calculadora_project --exclude=migrations
      continue-on-error: true
    
    - name: Check imports with isort
      run: |
        isort --check-only calculadora calculadora_project --skip migrations
      continue-on-error: true
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Run ESLint (if configured)
      working-directory: ./frontend
      run: npm run lint || echo "No lint script configured"
      continue-on-error: true

  # Job 4: Build Docker Images
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Backend Docker Image
      run: |
        docker build -t calculadora-backend:${{ github.sha }} .
    
    - name: Build Frontend Docker Image
      run: |
        docker build -t calculadora-frontend:${{ github.sha }} ./frontend
    
    - name: Test Docker Compose
      run: |
        docker-compose config
    
    - name: Login to Docker Hub (optional)
      if: github.ref == 'refs/heads/main'
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      continue-on-error: true
    
    - name: Push Docker images (optional)
      if: github.ref == 'refs/heads/main'
      run: |
        docker tag calculadora-backend:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/calculadora-backend:latest
        docker tag calculadora-frontend:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/calculadora-frontend:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/calculadora-backend:latest || echo "Docker push skipped"
        docker push ${{ secrets.DOCKER_USERNAME }}/calculadora-frontend:latest || echo "Docker push skipped"
      continue-on-error: true

  # Job 5: Security Scan
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true
    
    - name: Check Python dependencies for vulnerabilities
      run: |
        pip install safety
        safety check --json || echo "Vulnerability check completed"
      continue-on-error: true
    
    - name: Check npm dependencies for vulnerabilities
      working-directory: ./frontend
      run: |
        npm audit --audit-level=high || echo "npm audit completed"
      continue-on-error: true

  # Job 6: Deployment to VPS Ubuntu (solo en main)
  deploy:
    name: Deploy to VPS Ubuntu
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy notification start
      run: |
        echo "ðŸš€ Starting deployment to VPS Ubuntu..."
        echo "Server: ${{ secrets.VPS_HOST }}"
        echo "User: ${{ secrets.VPS_USERNAME }}"
    
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
    
    - name: Test SSH Connection
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "echo 'âœ… SSH connection successful'"
    
    - name: Create deployment directory on VPS
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          mkdir -p ${{ secrets.VPS_DEPLOY_PATH }}
          echo "ðŸ“ Deployment directory created/verified"
        EOF
    
    - name: Stop running containers (if any)
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd ${{ secrets.VPS_DEPLOY_PATH }}
          if [ -f docker-compose.yml ]; then
            docker-compose down || true
            echo "ðŸ›‘ Previous containers stopped"
          fi
        EOF
      continue-on-error: true
    
    - name: Transfer files to VPS
      run: |
        rsync -avz --delete \
          -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          --exclude 'venv' \
          --exclude 'node_modules' \
          --exclude '.git' \
          --exclude '__pycache__' \
          --exclude '*.pyc' \
          --exclude 'db.sqlite3' \
          --exclude '.env.local' \
          ./ ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_DEPLOY_PATH }}/
        echo "ðŸ“¦ Files transferred successfully"
    
    - name: Create/Update .env file on VPS
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd ${{ secrets.VPS_DEPLOY_PATH }}
          cat > .env << 'ENVEOF'
        SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
        DEBUG=False
        ALLOWED_HOSTS=${{ secrets.VPS_HOST }},${{ secrets.VPS_DOMAIN }},localhost,127.0.0.1
        CORS_ALLOWED_ORIGINS=http://${{ secrets.VPS_HOST }},https://${{ secrets.VPS_HOST }},http://${{ secrets.VPS_DOMAIN }},https://${{ secrets.VPS_DOMAIN }}
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        VITE_API_URL=http://${{ secrets.VPS_HOST }}:8000
        ENVEOF
          echo "âœ… .env file created"
        EOF
    
    - name: Install Docker and Docker Compose (if not installed)
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          if ! command -v docker &> /dev/null; then
            echo "ðŸ“¦ Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
            echo "âœ… Docker installed"
          else
            echo "âœ… Docker already installed"
          fi
          
          if ! command -v docker-compose &> /dev/null; then
            echo "ðŸ“¦ Installing Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            echo "âœ… Docker Compose installed"
          else
            echo "âœ… Docker Compose already installed"
          fi
        EOF
    
    - name: Build and start Docker containers
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd ${{ secrets.VPS_DEPLOY_PATH }}
          echo "ðŸ”¨ Building Docker images..."
          docker-compose build --no-cache
          echo "ðŸš€ Starting containers..."
          docker-compose up -d
          echo "âœ… Containers started successfully"
        EOF
    
    - name: Run Django migrations
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd ${{ secrets.VPS_DEPLOY_PATH }}
          echo "ðŸ”„ Running migrations..."
          docker-compose exec -T backend python manage.py migrate
          echo "âœ… Migrations completed"
        EOF
    
    - name: Collect static files
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd ${{ secrets.VPS_DEPLOY_PATH }}
          echo "ðŸ“¦ Collecting static files..."
          docker-compose exec -T backend python manage.py collectstatic --noinput
          echo "âœ… Static files collected"
        EOF
      continue-on-error: true
    
    - name: Verify deployment
      run: |
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          cd ${{ secrets.VPS_DEPLOY_PATH }}
          echo "ðŸ” Checking container status..."
          docker-compose ps
          echo "ðŸ“Š Container logs (last 20 lines):"
          docker-compose logs --tail=20
        EOF
    
    - name: Health check
      run: |
        echo "ðŸ¥ Waiting for services to be ready..."
        sleep 10
        ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
          echo "Testing backend health..."
          curl -f http://localhost:8000/api/calcular/ -X POST \
            -H "Content-Type: application/json" \
            -d '{"num1":2,"num2":2,"operacion":"sumar"}' \
            && echo "âœ… Backend is healthy" \
            || echo "âš ï¸ Backend health check failed"
        EOF
      continue-on-error: true
    
    - name: Cleanup SSH key
      if: always()
      run: |
        rm -f ~/.ssh/deploy_key
        echo "ðŸ§¹ SSH key cleaned up"
    
    - name: Deployment status summary
      run: |
        echo "âœ… ========================================="
        echo "âœ… DEPLOYMENT COMPLETED SUCCESSFULLY"
        echo "âœ… ========================================="
        echo "ðŸŒ Backend URL: http://${{ secrets.VPS_HOST }}:8000"
        echo "ðŸŒ Frontend URL: http://${{ secrets.VPS_HOST }}:5173"
        echo "ðŸ“ Server: ${{ secrets.VPS_HOST }}"
        echo "ðŸ“ Path: ${{ secrets.VPS_DEPLOY_PATH }}"
        echo "âœ… All services are running"
        echo "========================================="

  # Job 7: Status Summary
  status-summary:
    name: Pipeline Status Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, code-quality, docker-build, security-scan]
    if: always()
    
    steps:
    - name: Check job status
      run: |
        echo "ðŸ“Š CI/CD Pipeline Summary"
        echo "========================"
        echo "Backend Tests: ${{ needs.backend-tests.result }}"
        echo "Frontend Tests: ${{ needs.frontend-tests.result }}"
        echo "Code Quality: ${{ needs.code-quality.result }}"
        echo "Docker Build: ${{ needs.docker-build.result }}"
        echo "Security Scan: ${{ needs.security-scan.result }}"
    
    - name: Notify on failure
      if: contains(needs.*.result, 'failure')
      run: |
        echo "âŒ Pipeline failed! Please check the logs above."
        exit 1
    
    - name: Notify on success
      if: ${{ !contains(needs.*.result, 'failure') }}
      run: |
        echo "âœ… All CI/CD checks passed successfully!"
